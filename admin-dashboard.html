<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Horowednesday</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
<style>
  * {margin:0; padding:0; box-sizing:border-box; font-family:'Comfortaa', cursive;}
  body {background: linear-gradient(135deg,#b4e0ff,#d7c9ff); min-height:100vh; padding:20px;}
  h1 {color:#5d4fa2; margin-bottom:20px;}
  .logout {float:right; background:#f58a8a; color:#fff; padding:8px 15px; border:none; border-radius:10px; cursor:pointer;}
  table {width:100%; border-collapse: collapse; margin-top:20px;}
  th, td {padding:10px; border:1px solid #ccc; text-align:center;}
  th {background:#9d8de3; color:#fff;}
  button.view {background:#7ec4ff; color:#fff; border:none; padding:5px 10px; border-radius:8px; cursor:pointer;}
  button.view.disabled {background:#ccc; cursor:not-allowed;}
  .question-box {margin:10px 0; padding:10px; border:1px solid #ccc; border-radius:10px; background:#fff;}
  .question-box input {width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid #ccc;}
  .question-box button {margin-top:5px; background:#7ec4ff; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer;}
</style>
</head>
<body>

<h1>Admin Dashboard</h1>
<button class="logout" onclick="adminLogout()">Logout</button>

<h2>คิวลูกค้า</h2>
<table id="customer-table">
  <thead>
    <tr>
      <th>ลำดับ</th>
      <th>Username</th>
      <th>สถานะ</th>
      <th>ดูคำทำนาย</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="details"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBZR8mTUtdJC8nsajBd7hxZ1o6HFGslwUY",
  authDomain: "horowednesday.firebaseapp.com",
  projectId: "horowednesday",
  storageBucket: "horowednesday.appspot.com",
  messagingSenderId: "604956033127",
  appId: "1:604956033127:web:fec565a41020ccf28814c2",
  measurementId: "G-B38JLFJPVS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// เช็ก admin login
if(localStorage.getItem("adminLoggedIn") !== "true") {
  alert("กรุณาเข้าสู่ระบบก่อน");
  window.location.href="admin-login.html";
}

// Logout
function adminLogout(){
  localStorage.removeItem("adminLoggedIn");
  window.location.href="admin-login.html";
}

// โหลดคิวลูกค้า
async function loadCustomers(){
  const tableBody = document.querySelector("#customer-table tbody");
  tableBody.innerHTML = '';
  
  const usersSnapshot = await db.collection("users").get();
  let customers = [];
  
  for(const doc of usersSnapshot.docs){
    const userId = doc.id;
    const userData = doc.data();
    
    // ดึง payment ล่าสุด
    const paymentsSnap = await db.collection("users").doc(userId).collection("payments")
      .orderBy("datetime","asc").get();
    
    let status = "รอชำระเงิน";
    if(!paymentsSnap.empty){
      const lastPay = paymentsSnap.docs[paymentsSnap.docs.length-1].data();
      status = (lastPay.status === "paid") ? "รอทำนาย" : "รอชำระเงิน";
    }
    
    customers.push({userId, username:userData.username, status});
  }
  
  // เรียงตามเวลาชำระเงิน
  customers.sort((a,b)=>{
    return a.status==="รอทำนาย" ? -1 : 1;
  });
  
  customers.forEach((c,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${c.username}</td>
      <td>${c.status}</td>
      <td><button class="view ${c.status!=="ทำนายเสร็จแล้ว"?"disabled":""}" onclick="viewCustomer('${c.userId}')">ดูคำทำนาย</button></td>
    `;
    tableBody.appendChild(tr);
  });
}

async function viewCustomer(userId){
  const details = document.getElementById("details");
  details.innerHTML = '<h3>ข้อมูลลูกค้า</h3>';
  
  const userDoc = await db.collection("users").doc(userId).get();
  const userData = userDoc.data();
  
  details.innerHTML += `
    <p>ชื่อ: ${userData.name}</p>
    <p>วันเกิด: ${userData.birthday}</p>
    <p>เพศ: ${userData.gender}</p>
    <p>สถานะความสัมพันธ์: ${userData.relationship}</p>
    <p>อาชีพ: ${userData.job}</p>
  `;
  
  // ดึงคำถาม
  const qSnap = await db.collection("users").doc(userId).collection("questions").get();
  if(qSnap.empty){
    details.innerHTML += "<p>ยังไม่มีคำถาม</p>";
    return;
  }
  
  for(const qDoc of qSnap.docs){
    const q = qDoc.data();
    const qId = qDoc.id;
    
    details.innerHTML += `
      <div class="question-box" id="q-${qId}">
        <p><b>คำถาม:</b> ${q.question}</p>
        <p><b>ไพ่:</b> ${q.cards.join(", ")}</p>
        <p><b>คำทำนาย:</b></p>
        <input type="text" id="answer-${qId}" value="${q.answer || ''}" placeholder="กรอกคำทำนาย">
        <button onclick="submitAnswer('${userId}','${qId}')">ส่งคำทำนาย</button>
      </div>
    `;
  }
}

// ส่งคำทำนาย
function submitAnswer(userId,qId){
  const answer = document.getElementById(`answer-${qId}`).value;
  db.collection("users").doc(userId).collection("questions").doc(qId).update({
    answer: answer,
    status: "ทำนายเสร็จแล้ว"
  }).then(()=>{
    alert("ส่งคำทำนายเรียบร้อย!");
    loadCustomers();
    viewCustomer(userId);
  });
}

// โหลดตอนเปิดหน้า
loadCustomers();
</script>
</body>
</html>
