<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horowednesday - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
* { box-sizing:border-box; font-family:'Baloo 2', cursive; margin:0; padding:0; }
body { background:linear-gradient(135deg,#c3bef0,#b4e0ff); padding:20px; }
.container { max-width:700px; margin:auto; background:white; border-radius:20px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.header h1 { color:#5d4fa2; font-size:1.5rem; }
.header .btn-group { display:flex; gap:10px; flex-wrap:wrap; }
.btn { padding:8px 12px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; color:#fff; transition:0.3s; font-size:0.9rem; }
.btn:hover { transform:scale(1.05); }
.add-btn { background:#7ec4ff; }
.edit-btn { background:#9d8de3; }
.logout-btn { background:#f55; }
table { width:100%; border-collapse:collapse; }
th, td { padding:10px; text-align:left; border-bottom:1px solid #ddd; }
th { background:#d7cfff; color:#5d4fa2; }
.status-pending { color:#d69e2e; font-weight:bold; } /* รอคำทำนาย */
.status-done { color:#2b6a2b; font-weight:bold; } /* ทำนายเสร็จ */
.actions button { margin-right:5px; padding:5px 8px; font-size:0.8rem; }
@media (max-width:480px) {
  .header { flex-direction:column; align-items:flex-start; gap:10px; }
  th, td { font-size:0.9rem; padding:8px; }
  .btn { font-size:0.8rem; padding:6px 10px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Dashboard</h1>
    <div class="btn-group">
      <button class="btn add-btn" onclick="window.location.href='dashboard.html'">เพิ่มคำถามใหม่</button>
      <button class="btn edit-btn" onclick="window.location.href='edit-profile.html'">แก้ไขข้อมูล</button>
      <button class="btn logout-btn" onclick="logout()">ล็อกเอาท์</button>
    </div>
  </div>

  <table id="question-table">
    <thead>
      <tr>
        <th>ลำดับ</th>
        <th>คำถาม</th>
        <th>สถานะ</th>
        <th>การจัดการ</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">กำลังโหลดข้อมูล...</td></tr>
    </tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBZR8mTUtdJC8nsajBd7hxZ1o6HFGslwUY",
    authDomain: "horowednesday.firebaseapp.com",
    projectId: "horowednesday",
    storageBucket: "horowednesday.firebasestorage.app",
    messagingSenderId: "604956033127",
    appId: "1:604956033127:web:fec565a41020ccf28814c2",
    measurementId: "G-B38JLFJPVS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;

auth.onAuthStateChanged(async user => {
    if(user){
        currentUser = user;
        loadQuestions();
    } else {
        window.location.href = "index.html";
    }
});

function logout(){
    auth.signOut();
}

// โหลดคำถามและแสดงในตาราง
async function loadQuestions(){
    try{
        const snapshot = await db.collection("users").doc(currentUser.uid).collection("questions").orderBy("timestamp","desc").get();
        const tbody = document.querySelector("#question-table tbody");
        if(snapshot.empty){
            tbody.innerHTML = `<tr><td colspan="4">❌ ยังไม่มีคำถาม</td></tr>`;
            return;
        }
        let html="";
        snapshot.forEach((doc,index)=>{
            const d = doc.data();
            const question = d.question || "-";
            const prediction = d.prediction || null;
            const statusText = prediction ? "ทำนายเสร็จแล้ว" : "รอคำทำนาย";
            const statusClass = prediction ? "status-done" : "status-pending";

            html+=`
            <tr>
                <td>${index+1}</td>
                <td>${question}</td>
                <td class="${statusClass}">${statusText}</td>
                <td class="actions">
                    <button class="btn edit-btn" onclick="editQuestion('${doc.id}','${question.replace(/'/g,"\\'")}')">แก้ไข</button>
                    <button class="btn logout-btn" onclick="deleteQuestion('${doc.id}')">ลบ</button>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }catch(err){
        document.querySelector("#question-table tbody").innerHTML = `<tr><td colspan="4">⚠️ เกิดข้อผิดพลาด: ${err.message}</td></tr>`;
    }
}

// ฟังก์ชันแก้ไขคำถาม
function editQuestion(qid, oldQ){
    const newQ = prompt("แก้ไขคำถาม:", oldQ);
    if(newQ && newQ.trim()!==""){
        db.collection("users").doc(currentUser.uid).collection("questions").doc(qid)
        .update({question:newQ.trim(), timestamp:firebase.firestore.FieldValue.serverTimestamp()})
        .then(()=> loadQuestions())
        .catch(err=>alert("เกิดข้อผิดพลาด: "+err.message));
    }
}

// ฟังก์ชันลบคำถาม
function deleteQuestion(qid){
    if(confirm("คุณต้องการลบคำถามนี้ใช่หรือไม่?")){
        db.collection("users").doc(currentUser.uid).collection("questions").doc(qid)
        .delete()
        .then(()=>loadQuestions())
        .catch(err=>alert("เกิดข้อผิดพลาด: "+err.message));
    }
}
</script>
</body>
</html>
