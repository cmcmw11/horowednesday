<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horowednesday - ‡∏î‡∏π‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</title>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comfortaa', cursive;
      background: linear-gradient(135deg,#c9d6ff,#e2e2e2);
      margin:0; padding:0;
    }
    .container {
      max-width:900px;
      margin:30px auto;
      background:#fff;
      padding:30px;
      border-radius:20px;
      box-shadow:0 10px 25px rgba(0,0,0,0.1);
    }
    h1 { text-align:center; color:#5d4fa2; }
    h2 { color:#5d4fa2; margin-top:20px; }
    .user-info, .question-section {
      background:#f9f8ff;
      border-radius:15px;
      padding:15px;
      margin-top:10px;
    }
    .user-info p, .question-section p {
      margin:5px 0;
      color:#5d4fa2;
    }
    textarea {
      width:100%;
      border-radius:10px;
      border:1px solid #ccc;
      padding:10px;
      margin-top:10px;
      font-size:1rem;
    }
    button {
      background:linear-gradient(135deg,#9d8de3,#7ec4ff);
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:10px;
      cursor:pointer;
      margin-top:15px;
      transition:0.3s;
    }
    button:hover { transform:scale(1.05); }
    .back-btn { background:#ccc; color:#333; margin-right:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h1>
    <button class="back-btn" onclick="goBack()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>

    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
    <div class="user-info" id="user-info">
      <p>‡∏ä‡∏∑‡πà‡∏≠: -</p>
      <p>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: -</p>
      <p>‡πÄ‡∏û‡∏®: -</p>
      <p>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û: -</p>
      <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå: -</p>
    </div>

    <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h2>
    <div class="question-section" id="question-section">
      <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="q-date">-</span></p>
      <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="q-status">-</span></p>
      <p><strong>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</strong></p>
      <textarea id="q-text" readonly></textarea>

      <div id="answer-block">
        <p><strong>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</strong></p>
        <textarea id="q-answer" readonly></textarea>
      </div>

      <div id="edit-section" style="display:none;">
        <button onclick="enableEdit()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
        <button onclick="saveEdit()" style="display:none;" id="save-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBZR8mTUtdJC8nsajBd7hxZ1o6HFGslwUY",
      authDomain: "horowednesday.firebaseapp.com",
      projectId: "horowednesday",
      storageBucket: "horowednesday.firebasestorage.app",
      messagingSenderId: "604956033127",
      appId: "1:604956033127:web:fec565a41020ccf28814c2",
      measurementId: "G-B38JLFJPVS"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ‡∏£‡∏±‡∏ö uid ‡πÅ‡∏•‡∏∞ qid ‡∏à‡∏≤‡∏Å URL
    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get("uid");
    const qid = urlParams.get("qid");

    let currentUser, questionRef;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      loadUserInfo();
      loadQuestion();
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    function loadUserInfo() {
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("user-info").innerHTML = `
            <p>‡∏ä‡∏∑‡πà‡∏≠: ${data.name || "-"}</p>
            <p>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${data.birth || "-"}</p>
            <p>‡πÄ‡∏û‡∏®: ${data.gender || "-"}</p>
            <p>‡∏≠‡∏≤‡∏ä‡∏µ‡∏û: ${data.job || "-"}</p>
            <p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå: ${data.relationship || "-"}</p>
          `;
        }
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°/‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    async function loadQuestion() {
      questionRef = db.collection("users").doc(uid).collection("questions").doc(qid);
      const doc = await questionRef.get();
      if (!doc.exists) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ");

      const data = doc.data();
      document.getElementById("q-date").innerText = data.timestamp ? data.timestamp.toDate().toLocaleString("th-TH") : "-";
      document.getElementById("q-status").innerText = data.status || "-";
      document.getElementById("q-text").value = data.question || "-";
      document.getElementById("q-answer").value = data.answer || "-";

      // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ
      if (currentUser.uid === uid && (!data.answer || data.answer.trim() === "")) {
        document.getElementById("edit-section").style.display = "block";
      }
    }

    function enableEdit() {
      const qText = document.getElementById("q-text");
      qText.removeAttribute("readonly");
      document.getElementById("save-btn").style.display = "inline-block";
    }

    async function saveEdit() {
      const newQuestion = document.getElementById("q-text").value.trim();
      if (!newQuestion) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°");

      await questionRef.update({ question: newQuestion });
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
      document.getElementById("q-text").setAttribute("readonly", true);
      document.getElementById("save-btn").style.display = "none";
    }

    function goBack() {
      window.location.href = "prediction.html";
    }
  </script>
</body>
</html>
