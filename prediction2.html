<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horowednesday - คำทำนายทั้งหมด</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing:border-box; font-family:'Baloo 2', cursive; }
  body { background:linear-gradient(135deg,#c3bef0,#b4e0ff); padding:20px; }
  .container { background:white; border-radius:20px; padding:25px; max-width:700px; margin:auto; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
  h1 { text-align:center; color:#5d4fa2; margin-bottom:15px; }
  .user-info { background:#f3f0ff; padding:15px; border-radius:12px; margin-bottom:20px; }
  .user-info p { color:#5d4fa2; margin:3px 0; }
  
  .accordion { border-radius:12px; margin-bottom:15px; overflow:hidden; border:1px solid #d7cfff; }
  .accordion-header { padding:15px; cursor:pointer; font-weight:bold; display:flex; justify-content:space-between; align-items:center; background:#d7cfff; color:#5d4fa2; }
  .accordion-header:hover { background:#cfc3ff; }
  .accordion-header.predicted { background:#b6f5c3; color:#2b6a2b; }
  .accordion-content { display:none; padding:15px; background:white; color:#333; }
  
  .btn { padding:5px 10px; border:none; border-radius:8px; margin:5px 5px 0 0; cursor:pointer; color:#fff; font-weight:bold; transition:0.3s; }
  .btn:hover { transform:scale(1.05); }
  .edit-btn { background:#9d8de3; }
  .delete-btn { background:#f55; }
  .back-btn { background:#ccc; color:#333; margin-top:20px; display:block; }

  textarea { width:100%; border-radius:10px; border:1px solid #ccc; padding:10px; resize:none; margin-top:5px; }
  .edit-section { margin-top:10px; display:none; }
</style>
</head>
<body>
<div class="container">
  <h1>รายการคำทำนาย</h1>

  <div class="user-info" id="user-info">
    <p><strong>ชื่อ:</strong> <span id="u-name"></span></p>
    <p><strong>วันเกิด:</strong> <span id="u-birth"></span></p>
    <p><strong>เพศ:</strong> <span id="u-gender"></span></p>
    <p><strong>อาชีพ:</strong> <span id="u-job"></span></p>
    <p><strong>สถานะความสัมพันธ์:</strong> <span id="u-relationship"></span></p>
  </div>

  <div id="prediction-data">
    <p>กำลังโหลดข้อมูล...</p>
  </div>

  <button class="back-btn" onclick="window.location.href='prediction.html'">← กลับหน้าหลัก</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBZR8mTUtdJC8nsajBd7hxZ1o6HFGslwUY",
    authDomain: "horowednesday.firebaseapp.com",
    projectId: "horowednesday",
    storageBucket: "horowednesday.firebasestorage.app",
    messagingSenderId: "604956033127",
    appId: "1:604956033127:web:fec565a41020ccf28814c2",
    measurementId: "G-B38JLFJPVS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;

auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        await loadUserInfo();
        loadAllPredictions();
    } else {
        window.location.href = "index.html";
    }
});

async function loadUserInfo() {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    if (doc.exists) {
        const u = doc.data();
        document.getElementById("u-name").innerText = u.name || "-";
        document.getElementById("u-birth").innerText = u.birth || "-";
        document.getElementById("u-gender").innerText = u.gender || "-";
        document.getElementById("u-job").innerText = u.job || "-";
        document.getElementById("u-relationship").innerText = u.relationship || "-";
    }
}

async function loadAllPredictions() {
    try {
        const snapshot = await db.collection("users").doc(currentUser.uid).collection("questions").orderBy("timestamp", "desc").get();
        if (snapshot.empty) {
            document.getElementById('prediction-data').innerHTML = "<p>❌ ยังไม่มีคำถาม</p>";
            return;
        }

        let html = "";
        snapshot.forEach((doc, index) => {
            const d = doc.data();
            const date = d.timestamp?.toDate().toLocaleString("th-TH") || "-";
            const status = d.status || "-";
            const question = d.question || "-";
            const prediction = d.prediction || null;
            const cards = (d.cards || []).join(", ") || "-";

            // กำหนด class สีเขียวถ้ามีคำทำนาย
            const headerClass = prediction ? "accordion-header predicted" : "accordion-header";

            html += `
            <div class="accordion" data-id="${doc.id}">
                <div class="${headerClass}">
                    <span>${index + 1}. ${question}</span>
                    <span>▼</span>
                </div>
                <div class="accordion-content">
                    <p><strong>วันที่:</strong> ${date}</p>
                    <p><strong>สถานะ:</strong> ${status}</p>
                    <p><strong>คำทำนาย:</strong> ${prediction || "ยังไม่มีคำทำนาย"}</p>
                    <p><strong>ไพ่ที่เลือก:</strong> ${cards}</p>
                    <div class="edit-section">
                        <textarea rows="2" placeholder="แก้ไขคำถาม">${question}</textarea>
                        <button class="btn edit-btn">บันทึกแก้ไข</button>
                        <button class="btn delete-btn">ลบคำถาม</button>
                    </div>
                    <button class="btn edit-btn toggle-edit">แก้ไขคำถาม</button>
                </div>
            </div>`;
        });

        document.getElementById('prediction-data').innerHTML = html;

        // เปิด/ปิด accordion
        const accHeaders = document.querySelectorAll(".accordion-header");
        accHeaders.forEach(header => {
            header.addEventListener("click", () => {
                const content = header.nextElementSibling;
                content.style.display = content.style.display === "block" ? "none" : "block";
            });
        });

        // toggle edit section
        const toggleEditBtns = document.querySelectorAll(".toggle-edit");
        toggleEditBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                const editSection = btn.parentElement.querySelector(".edit-section");
                editSection.style.display = editSection.style.display === "block" ? "none" : "block";
            });
        });

        // บันทึกแก้ไขคำถาม
        const editBtns = document.querySelectorAll(".edit-section .edit-btn");
        editBtns.forEach((btn, i) => {
            btn.addEventListener("click", async () => {
                const parent = btn.closest(".accordion");
                const newQ = parent.querySelector("textarea").value.trim();
                if(!newQ) return alert("กรุณากรอกคำถามใหม่");
                try {
                    await db.collection("users").doc(currentUser.uid)
                        .collection("questions").doc(parent.dataset.id)
                        .update({ question: newQ, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    alert("แก้ไขคำถามเรียบร้อย!");
                    loadAllPredictions();
                } catch(err) {
                    alert("เกิดข้อผิดพลาด: " + err.message);
                }
            });
        });

        // ลบคำถาม
        const deleteBtns = document.querySelectorAll(".edit-section .delete-btn");
        deleteBtns.forEach((btn) => {
            btn.addEventListener("click", async () => {
                const parent = btn.closest(".accordion");
                if(!confirm("คุณต้องการลบคำถามนี้ใช่หรือไม่?")) return;
                try {
                    await db.collection("users").doc(currentUser.uid)
                        .collection("questions").doc(parent.dataset.id)
                        .delete();
                    alert("ลบคำถามเรียบร้อย!");
                    loadAllPredictions();
                } catch(err) {
                    alert("เกิดข้อผิดพลาด: " + err.message);
                }
            });
        });

    } catch (err) {
        document.getElementById('prediction-data').innerHTML = `<p>⚠️ เกิดข้อผิดพลาด: ${err.message}</p>`;
    }
}
</script>
</body>
</html>
