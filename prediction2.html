<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horowednesday - คำทำนายทั้งหมด</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing:border-box; font-family:'Baloo 2', cursive; }
  body { background:linear-gradient(135deg,#c3bef0,#b4e0ff); padding:20px; }
  .container { background:white; border-radius:20px; padding:25px; max-width:700px; margin:auto; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
  h1 { text-align:center; color:#5d4fa2; margin-bottom:15px; }
  .user-info { background:#f3f0ff; padding:15px; border-radius:12px; margin-bottom:20px; }
  .user-info p { color:#5d4fa2; margin:3px 0; }
  
  .accordion { background:#f3f0ff; border-radius:12px; margin-bottom:15px; overflow:hidden; }
  .accordion-header { padding:15px; cursor:pointer; font-weight:bold; color:#5d4fa2; display:flex; justify-content:space-between; align-items:center; }
  .accordion-header:hover { background:#e0dbff; }
  .accordion-content { display:none; padding:15px; border-top:1px solid #d7cfff; background:white; color:#333; border-radius:0 0 12px 12px; }

  button { padding:10px 15px; border:none; border-radius:10px; margin-top:10px; cursor:pointer; background:linear-gradient(135deg,#9d8de3,#7ec4ff); color:#fff; font-weight:bold; transition:0.3s; }
  button:hover { transform:scale(1.05); }
  .back-btn { background:#ccc; color:#333; }
</style>
</head>
<body>
<div class="container">
  <h1>รายการคำทำนาย</h1>

  <!-- ข้อมูลผู้ใช้ -->
  <div class="user-info" id="user-info">
    <p><strong>ชื่อ:</strong> <span id="u-name"></span></p>
    <p><strong>วันเกิด:</strong> <span id="u-birth"></span></p>
    <p><strong>เพศ:</strong> <span id="u-gender"></span></p>
    <p><strong>อาชีพ:</strong> <span id="u-job"></span></p>
    <p><strong>สถานะความสัมพันธ์:</strong> <span id="u-relationship"></span></p>
  </div>

  <!-- รายการคำถาม -->
  <div id="prediction-data">
    <p>กำลังโหลดข้อมูล...</p>
  </div>

  <button class="back-btn" onclick="window.location.href='prediction.html'">← กลับหน้าหลัก</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBZR8mTUtdJC8nsajBd7hxZ1o6HFGslwUY",
    authDomain: "horowednesday.firebaseapp.com",
    projectId: "horowednesday",
    storageBucket: "horowednesday.firebasestorage.app",
    messagingSenderId: "604956033127",
    appId: "1:604956033127:web:fec565a41020ccf28814c2",
    measurementId: "G-B38JLFJPVS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;

auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        await loadUserInfo();
        loadAllPredictions();
    } else {
        window.location.href = "index.html";
    }
});

async function loadUserInfo() {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    if (doc.exists) {
        const u = doc.data();
        document.getElementById("u-name").innerText = u.name || "-";
        document.getElementById("u-birth").innerText = u.birth || "-";
        document.getElementById("u-gender").innerText = u.gender || "-";
        document.getElementById("u-job").innerText = u.job || "-";
        document.getElementById("u-relationship").innerText = u.relationship || "-";
    }
}

async function loadAllPredictions() {
    try {
        const snapshot = await db.collection("users").doc(currentUser.uid).collection("questions").orderBy("timestamp", "desc").get();
        if (snapshot.empty) {
            document.getElementById('prediction-data').innerHTML = "<p>❌ ยังไม่มีคำถาม</p>";
            return;
        }

        let html = "";
        snapshot.forEach((doc, index) => {
            const d = doc.data();
            const date = d.timestamp?.toDate().toLocaleString("th-TH") || "-";
            const status = d.status || "-";
            const question = d.question || "-";
            const prediction = d.prediction || "ยังไม่มีคำทำนาย";
            const cards = (d.cards || []).join(", ");

            html += `
            <div class="accordion">
                <div class="accordion-header">
                    <span>${index + 1}. ${question}</span>
                    <span>▼</span>
                </div>
                <div class="accordion-content">
                    <p><strong>วันที่:</strong> ${date}</p>
                    <p><strong>สถานะ:</strong> ${status}</p>
                    <p><strong>คำทำนาย:</strong> ${prediction}</p>
                    <p><strong>ไพ่ที่เลือก:</strong> ${cards}</p>
                </div>
            </div>`;
        });

        document.getElementById('prediction-data').innerHTML = html;

        // เปิด/ปิด accordion
        const acc = document.querySelectorAll(".accordion-header");
        acc.forEach(header => {
            header.addEventListener("click", () => {
                const content = header.nextElementSibling;
                content.style.display = content.style.display === "block" ? "none" : "block";
            });
        });

    } catch (err) {
        document.getElementById('prediction-data').innerHTML = `<p>⚠️ เกิดข้อผิดพลาด: ${err.message}</p>`;
    }
}
</script>
</body>
</html>
